Parameters:
  DatabasePassword:
    Type: String
    Default: 'oK6Jsqseqtx#Jn7reWi^WD'

Resources:
  DockerRegistry:
    Type: AWS::ECR::Repository
  StaticHostingBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: PublicRead
      WebsiteConfiguration:
        IndexDocument: index.html
  DatabasePassword:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Value: !Ref DatabasePassword
  Database:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceClass: db.t2.micro
      Engine: postgres
      MasterUserPassword: !GetAtt DatabasePassword.Value
  CICDPipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - codepipeline.amazonaws.com
              Action:
                - 'sts:AssumeRole'
          Policies:
            - PolicyName: EnableDockerRegistryPush
              PolicyDocument:
                Version: '2012-10-17'
                Statement:
                  - Effect: Allow
                    Action: 'ecr:PutImage'
                    Resource: !GetAtt DockerRegistry.Arn
            - PolicyName: EnableS3Upload
              PolicyDocument:
                Version: '2012-10-17'
                Statement:
                  - Effect: Allow
                    Action: 's3:PutObject'
                    Resource: !GetAtt DockerRegistry.Arn
  CICDPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn: !GetAtt CICDPipelineRole.Arn
      Stages:
        - Name: 'Checkout code'
          Actions:
            - Name: 'Checkout from GitHub'
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: '1'
              OutputArtifacts:
                - Name: SourceOutput
              Configuration:
                Repo: 'https://github.com/csuvikg/devops-challenge'
                Branch: 'master'
                PollForSourceChanges: false
              RunOrder: 1
        - Name: 'Build and push docker image'
          Actions:
            - Name: 'Build docker image'
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                

              #          Actions:
#        - Name: 'Upload static content to S3 bucket'
#          Actions:
